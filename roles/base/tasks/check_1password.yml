# Copyright (c) 2026 T.R. Fullhart. All Rights Reserved.
---
- name: Check if op is installed
  ansible.builtin.shell: command -v op
  register: base_op_check
  ignore_errors: true
  changed_when: false
  # noqa: command-instead-of-shell
  environment:
    PATH: "{{ lookup('env', 'HOME') }}/.local/share/mise/shims:{{ lookup('env', 'HOME') }}/.local/bin:{{ lookup('env', 'PATH') }}"

- name: Install 1Password CLI via mise if missing
  when: base_op_check.rc != 0
  block:
    - name: Check if mise is installed
      ansible.builtin.shell: command -v "{{ lookup('env', 'HOME') }}/.local/bin/mise"
      register: base_mise_check
      ignore_errors: true
      changed_when: false
      # noqa: command-instead-of-shell

    - name: Install mise
      ansible.builtin.shell: |
        set -o pipefail
        curl https://mise.run | sh
      args:
        creates: "{{ lookup('env', 'HOME') }}/.local/bin/mise"
      when: base_mise_check.rc != 0
      # noqa: command-instead-of-module

    - name: Trust project mise config
      ansible.builtin.command: "{{ lookup('env', 'HOME') }}/.local/bin/mise trust"
      args:
        chdir: "{{ playbook_dir }}"
      changed_when: false
      environment:
        PATH: "{{ lookup('env', 'HOME') }}/.local/bin:{{ lookup('env', 'PATH') }}"

    - name: Install 1password-cli with mise
      ansible.builtin.command: "{{ lookup('env', 'HOME') }}/.local/bin/mise use -g 1password-cli"
      changed_when: true
      environment:
        PATH: "{{ lookup('env', 'HOME') }}/.local/bin:{{ lookup('env', 'PATH') }}"

- name: "System | Check 1Password Session"
  ansible.builtin.command: op vault list
  changed_when: false
  environment:
    PATH: "{{ lookup('env', 'HOME') }}/.local/share/mise/shims:{{ lookup('env', 'HOME') }}/.local/bin:{{ lookup('env', 'PATH') }}"
